"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],a=!0,r=!1,o=undefined;try{for(var i,c=e[Symbol.iterator]();!(a=(i=c.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(s){r=!0,o=s}finally{try{!a&&c["return"]&&c["return"]()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(){var e={};e.parcelPointLinks={trigger:".bw-select-parcel",mapContainer:null,map:null,markers:[],initMap:function(){var e=this,t=document.createElement("div");t.setAttribute("class","bw-close"),t.setAttribute("title",translations.text.closeMap),t.addEventListener("click",function(){e.closeMap()});var n=document.createElement("div");n.setAttribute("id","bw-map-canvas");var a=document.createElement("div");a.setAttribute("id","bw-map-container"),a.appendChild(n);var r=document.createElement("div");r.setAttribute("id","bw-pp-container");var o=document.createElement("div");o.setAttribute("id","bw-map-inner"),o.appendChild(t),o.appendChild(a),o.appendChild(r),e.mapContainer=document.createElement("div"),e.mapContainer.setAttribute("id","bw-map"),e.mapContainer.appendChild(o),document.body.appendChild(e.mapContainer),e.map=new mapboxgl.Map({container:"bw-map-canvas",style:mapUrl,zoom:14,accessToken:"whatever"}),e.map.addControl(new mapboxgl.NavigationControl);var i=document.createElement("img");i.setAttribute("src",mapLogoImageUrl);var c=document.createElement("a");c.setAttribute("href",mapLogoHrefUrl),c.setAttribute("target","_blank"),c.appendChild(i);var s=document.createElement("div");s.setAttribute("id","bw-boxtal-logo"),s.appendChild(c);var l=document.querySelector(".mapboxgl-ctrl-top-left");l&&l.appendChild(s)},init:function(){var e=this;e.on("body","click",e.trigger,function(){e.mapContainer=document.querySelector("#bw-map"),e.mapContainer||e.initMap(),e.openMap(),e.getPoints()}),e.on("body","click",".bw-parcel-point-button",function(){e.selectPoint(this.getAttribute("data-code"),unescape(this.getAttribute("data-name")),this.getAttribute("data-network"),unescape(this.getAttribute("data-street")),unescape(this.getAttribute("data-zipcode")),unescape(this.getAttribute("data-city")),unescape(this.getAttribute("data-country")),unescape(this.getAttribute("data-openinghours")),unescape(this.getAttribute("data-distance"))).then(function(t){var n=_slicedToArray(t,5),a=n[0],r=n[1],o=n[2],i=n[3],c=n[4];e.initSelectedParcelPoint();var s=document.querySelector(".bw-parcel-name");document.querySelector(".bw-tooltip-address").setAttribute("title",e.getParcelPoingAddress(r,i,o,c)),s.innerHTML=a,e.closeMap()})["catch"](function(t){e.showError(t)})})},openMap:function(){this.mapContainer.classList.add("bw-modal-show");var e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},closeMap:function(){this.mapContainer.classList.remove("bw-modal-show"),this.clearMarkers()},initSelectedParcelPoint:function(){var e=document.querySelector(".bw-parcel-client");e.innerHTML=translations.text.selectedParcelPoint+" ";var t=document.createElement("span");t.setAttribute("class","bw-parcel-name"),e.appendChild(t)},formatDistance:function(e){var t=null;return null!==e&&(e=Math.round(e/100)/10,isNaN(e)||(t=" ("+translations.text.kmaway.replace("%s",e)+")")),t},getParcelPoingAddress:function(e,t,n,a){var r=[e,[n,t].filter(function(e){return null!==e}).join(", ")].join(" ");return null!==(a=this.formatDistance(a))&&(r+=" "+a),r},getPoints:function(){var e=this;e.getParcelPoints().then(function(t){e.addParcelPointMarkers(t.nearbyParcelPoints),e.fillParcelPointPanel(t.nearbyParcelPoints),e.addRecipientMarker(t.searchLocation),e.setMapBounds()})["catch"](function(t){e.showError(t)})},getParcelPoints:function(){var e=this;return new Promise(function(t,n){var a=e.getSelectedCarrier();a||n(translations.error.carrierNotFound);var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){var e="object"===_typeof(r.response)&&null!==r.response?r.response:JSON.parse(r.response);!1===e.success?n(e.data.message):t(e)}},r.open("POST",ajaxurl),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.responseType="json",r.send("action=bw_get_points&carrier="+encodeURIComponent(a))})},addParcelPointMarkers:function(e){for(var t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},fillSpaces:function(e,t){for(;e.length<t;)e+=" ";return e},formatOpeningDays:function(e){for(var t=[],n=this.fillSpaces("",11),a=0;a<e.length;a++){var r=e[a];if(r.weekday){for(var o=r.weekday[0]+" ",i=r.openingPeriods,c=[],s=0;s<i.length;s++){var l=i[s],p=l.openingTime===undefined?"":l.openingTime,d=l.closingTime===undefined?"":l.closingTime;""!==p&&""!==d?c.push(p+"-"+d):c.push(n)}o+=c.join(" "),a%2==1&&(o='<span style="background-color: #d8d8d8;">'+o+"</span>"),t.push(o)}}return'<pre class="bw-parcel-point-schedule">'+t.join("\n")+"</pre>"},generateParcelPointTagData:function(e){return' data-code="'+e.parcelPoint.code+'" data-name="'+escape(e.parcelPoint.name)+'" data-network="'+e.parcelPoint.network+'" data-zipcode="'+escape(e.parcelPoint.location.zipCode)+'" data-country="'+escape(e.parcelPoint.location.country)+'" data-city="'+escape(e.parcelPoint.location.city)+'" data-street="'+escape(e.parcelPoint.location.street)+'" data-openinghours="'+escape(JSON.stringify(e.parcelPoint.openingDays))+'" data-distance="'+escape(JSON.stringify(e.distanceFromSearchLocation))+'" '},addParcelPointMarker:function(e){var t="<div class='bw-marker-popup'><b>"+e.parcelPoint.name+'</b><br/><a href="#" class="bw-parcel-point-button" '+this.generateParcelPointTagData(e)+"><b>"+translations.text.chooseParcelPoint+"</b></a><br/>"+e.parcelPoint.location.street+", "+e.parcelPoint.location.zipCode+" "+e.parcelPoint.location.city+"<br/><b>"+translations.text.openingHours+"</b><br/>";t+=this.formatOpeningDays(e.parcelPoint.openingDays);var n=this.getMarkerHtmlElement(e.index+1),a=new mapboxgl.Popup({offset:25}).setHTML(t),r=new mapboxgl.Marker({element:n,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.parcelPoint.location.position.longitude),parseFloat(e.parcelPoint.location.position.latitude))).setPopup(a).addTo(this.map);this.markers.push(r),this.addRightColMarkerEvent(r,e.parcelPoint.code)},addRightColMarkerEvent:function(e,t){this.on("body","click",".bw-show-info-"+t,function(){e.togglePopup()})},formatHours:function(e){var t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},addRecipientMarker:function(e){var t=document.createElement("div");t.className="bw-marker-recipient";var n=new mapboxgl.Marker({element:t,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(n)},setMapBounds:function(){for(var e=new mapboxgl.LngLatBounds,t=0;t<this.markers.length;t++){var n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(e){var t="";t+="<table><tbody>";for(var n=0;n<e.length;n++){var a=e[n],r=this.formatDistance(a.distanceFromSearchLocation);t+="<tr>",t+="<td>"+this.getMarkerHtmlElement(n+1).outerHTML,t+='<div class="bw-parcel-point-title"><a class="bw-show-info-'+a.parcelPoint.code+'">'+a.parcelPoint.name+"</a></div><br/>",t+=a.parcelPoint.location.street+"<br/>",t+=a.parcelPoint.location.zipCode+" "+a.parcelPoint.location.city+(null!==r?r:"")+"<br/>",t+='<a class="bw-parcel-point-button" '+this.generateParcelPointTagData(a)+"><b>"+translations.text.chooseParcelPoint+"</b></a>",t+="</td>",t+="</tr>"}t+="</tbody></table>",document.querySelector("#bw-pp-container").innerHTML=t},getMarkerHtmlElement:function(e){var t=document.createElement("div");return t.className="bw-marker",t.innerHTML=e,t},selectPoint:function(e,t,n,a,r,o,i,c,s){var l=this;return new Promise(function(p,d){var u=l.getSelectedCarrier();u||d(translations.error.carrierNotFound);var m=new XMLHttpRequest;m.onreadystatechange=function(){if(4===m.readyState){var e="object"===_typeof(m.response)&&null!==m.response?m.response:JSON.parse(m.response);!1===e.success?d(e.data.message):p([t,a,r,o,s])}},m.open("POST",ajaxurl),m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.responseType="json",m.send("action=bw_set_point&carrier="+encodeURIComponent(u)+"&code="+encodeURIComponent(e)+"&name="+encodeURIComponent(t)+"&address="+encodeURIComponent(a)+"&zipcode="+encodeURIComponent(r)+"&city="+encodeURIComponent(o)+"&country="+encodeURIComponent(i)+"&openingHours="+encodeURIComponent(c)+"&network="+encodeURIComponent(n))})},clearMarkers:function(){for(var e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getSelectedCarrier:function(){var e=void 0,t=document.querySelector('input[type="hidden"].shipping_method');t?e=t.getAttribute("value"):e=document.querySelector("input.shipping_method:checked").getAttribute("value");return e},showError:function(e){this.closeMap(),alert(e)},on:function(e,t,n,a){var r=document.querySelector(e);r.addEventListener(t,function(e){for(var t=r.querySelectorAll(n),o=e.target,i=0,c=t.length;i<c;i++)for(var s=o,l=t[i];s&&s!==r;){if(s===l)return a.call(l,e);s=s.parentNode}})}},document.addEventListener("DOMContentLoaded",function(){e.parcelPointLinks.init()})}();